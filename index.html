<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Maze 3D - Research Environment</title>
    <meta name="description" content="3D Maze with Fire Simulation and Eye Tracking" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" media="screen" href="assets/css/style.css" />
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        #calibration-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 9999;
            font-family: 'Segoe UI', sans-serif;
            opacity: 0.98;
        }
        .calib-instructions {
            position: absolute; top: 10%; width: 100%;
            text-align: center; 
            color: var(--text-color);
        }
        #webgazerVideoFeed, #webgazerVideoCanvas, #webgazerFaceOverlay, #webgazerFaceFeedbackBox {
            display: block !important;
            visibility: visible !important;
        }
    </style>
  </head>
  <body class="theme-night">
    <div id="setup-screen">
        <div class="setup-box">
            <h1>EXPERIMENT SETUP</h1>
            
            <p>CHOOSE UI THEME:</p>
            <div class="theme-select" style="margin-bottom: 2rem; display: flex; gap: 1rem; justify-content: center;">
                <button class="theme-toggle-btn day-btn" onclick="setTheme('day')">‚òÄÔ∏è DAY MODE</button>
                <button class="theme-toggle-btn night-btn" onclick="setTheme('night')">üåô NIGHT MODE</button>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin-bottom: 2rem;">

            <p>SELECT YOUR GROUP:</p>
            <div class="mode-select">
                <button class="setup-btn" onclick="startGame('minimap')">
                    GROUP A: MINIMAP
                    <span class="desc">Navigational aid provided</span>
                </button>
                <button class="setup-btn" onclick="startGame('xray')">
                    GROUP B: X-RAY
                    <span class="desc">Structural transparency enabled</span>
                </button>
            </div>
        </div>
    </div>

    <div id="calibration-overlay">
        <div class="calib-instructions">
            <h2 id="calib-title" style="font-size: clamp(1.2rem, 3vw, 2rem);">EYE TRACKING CALIBRATION</h2>
            <p id="calib-instruction">Stare at the red dot and click it 5 times.</p>
            <p id="calib-status">Progress: 0/9 dots</p>
        </div>
    </div>
    
    <div id="ui-layer">
        <div id="hud-left" class="hud-panel">
            <div class="webcam-container">
                <div id="webgazer-target"></div>
                <div class="scanner-overlay"></div>
            </div>
        </div>

        <div id="hud-top">
            <button class="hud-btn" onclick="togglePanel('hud-left')" title="Toggle Gaze Feed">
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
            <button id="btn-toggle-map" class="hud-btn" onclick="togglePanel('hud-right')" title="Toggle Map">
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
            </button>
            <button class="hud-btn warning" id="btn-export" onclick="downloadMazeData()" title="Download Logs">
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
        </div>

        <div id="hud-right" class="hud-panel">
            <div id="minimap-container">
                <canvas id="minimap"></canvas>
                <canvas id="objects"></canvas>
            </div>
        </div>
    </div>

    <div id="canvasContainer"></div>

    <audio id="bumpSound">
      <source src="assets/sound/bat.mp3" />
    </audio>

    <script src="assets/js/three.min.js"></script>
    <script src="assets/js/Demonixis.Input.js"></script>
    <script src="assets/js/Demonixis.Minimap.js"></script>
    <script src="assets/js/Demonixis.GameHelper.js"></script>
    <script src="assets/js/maze3d.js"></script>

    <script>
      function setTheme(t) {
        document.body.className = 'theme-' + t;
        localStorage.setItem('user-theme', t);
      }

      function togglePanel(pId) {
        var p = document.getElementById(pId);
        if (p) {
            var isHidden = (window.getComputedStyle(p).opacity === '0');
            p.style.opacity = isHidden ? '1' : '0';
            p.style.pointerEvents = isHidden ? 'auto' : 'none';
        }
      }

      window.onload = function() {
          const saved = localStorage.getItem('user-theme') || 'night';
          setTheme(saved);
      }
    </script>
  </body>
</html>